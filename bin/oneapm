#!/usr/bin/env node
"use strict";

var child_process = require('child_process');
var chalk = require('chalk');

var argv = require('yargs')
  .usage('Usage: $0 <command> [options] filename')

  .command('start', 'Use oneapm to start an application')
  .example('start', 'oneapm start index.js')

  .demand(1)

  .default('host', '127.0.0.1', 'Dashboard server hostname')
  .default('port', 8088, 'Dashboard server port')

  .help('help')
  .describe('help', 'Show this message')

  .alias('p', 'port')
  .alias('H', 'host')
  .alias('h', 'help')
  .alias('v', 'version')

  .version(function () {
    return require('../package').version;
  })

  .epilog('Copyright 2015, OneAPM, Inc')
  .argv;

var fileName = argv._.pop();

var port = argv.port;

var host = argv.host;

var cookedFileName = require('path').join(process.cwd(), fileName);

var fs = require('fs');

var conent = fs.readFileSync(cookedFileName).toString();
var injectContent = fs.readFileSync(require('path').join(__dirname, '..', 'inject.js')).toString();

var debug = require('debug')('oneapm-master-pid.' + process.pid);

fs.writeFileSync(cookedFileName + '.mod', injectContent + '\n' + conent);

var p = child_process.spawn('node', [cookedFileName + '.mod'], {
  env: require('util')._extend(process.env, {
    NODE_PATH: process.env.NODE_PATH + ":" + require('path').join(__dirname, '..', 'node_modules')
  }),
  stdio: 'inherit'
});

debug('child spawned pid=%d', p.pid);

p.on('close', function (exitCode) {
  process.exit(exitCode);
});

var server = require('../lib/MonitorServer.js')(p);

server.listen(port, host, function () {
  debug('Visit http://%s:%d to see the dashboard', host, port, p.pid);
});

require('../lib/WSServer')(8007, p.pid);

var WebSocketServer = require('ws').Server;

var wss = new WebSocketServer({
  port: 8006
});

wss.on('connection', function (ws) {
  p.ws = ws;
  ws.on('message', function (msg) {
    debug('message received:%s', msg);
  })
  ws.send('ping')
})